---
title: "Final_deliverable"
author: "Enxhi Xhindoli"
date: "1 May 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r include=FALSE}
library(rvest)
library(stringr)
library(tidyverse)
library(dplyr)
```

## Data Collection

The telecomunication company provided the LSU team with different datasets about demographics and rate changes. For the scope of this project, only a subset of the whole dataset was used. The variable BAN_SEQ is the ID which identifies a unique customer. 
```{r echo=FALSE, message=FALSE}
RCU <- read.csv("C:/Users/enxhi/Desktop/R_independentstudy/R_project/Data/RateChangeUnique.csv", sep =",", header=TRUE)

RCU$SNAPSHOT_DATE <- as.character(RCU$SNAPSHOT_DATE)
RCU$SNAPSHOT_DATE <- as.Date(RCU$SNAPSHOT_DATE, format = "%m/%d/%Y")

RCU_2015 <-RCU %>% 
  filter(SNAPSHOT_DATE>'2014-12-31' & SNAPSHOT_DATE<'2016-01-31')

```

```{r echo=FALSE, message=FALSE}
DEMO <- read.csv("C:/Users/enxhi/Desktop/R_independentstudy/R_project/Data/DEMO.csv", sep =",", header=TRUE)
DF <- merge(DEMO,RCU, by = "BAN_SEQ")
```

```{r include=FALSE}
write.csv(DF, file="C:/Users/enxhi/Desktop/R_independentstudy/R_project/Data/Rate_Demo.csv")
```

#Scraping

In order to add some information about the income, a table containing the average income per state was brought from the website into the Global Environment of Rstudio.

```{r income}
income2 <- read_html("https://www.infoplease.com/business-finance/poverty-and-income/capita-personal-income-state") %>%
  html_node(css = "#A0104653")%>%
  html_table()
```

For the purpose of this project, only the column showing the average income of each state in 2015 was kept.

```{r}
income <- as_tibble(income)
income <- select(income, State,`2015`)
income[1:3,]
```

```{r include=FALSE}
typeof(income)
```

To change this column's format, as we want it to be homogeneous, stringr package seems to be the right solution.

```{r results="hide", message=FALSE}
income <- income %>%
  mutate(`2015`=str_extract_all(`2015`,"[0-9]+"))%>%
  mutate(`2015`=map_chr(`2015`,paste,collapse=""))

income <- as.data.frame(income)
names(income)[names(income) == "2015"] <- "AVG_INCOME_2015"
names(income)[names(income) == "State"] <- "STATE"
```

In the dataset provided by the company, the states are represented only with their abbreviation. Therefore, another table, - containing the states and their abbreviations,- was extracted from the following website.
```{r}
head(income)
```

```{r state_abbreviation}
url2 <- read_html("https://www.50states.com/abbreviations.htm")

states <- url2 %>%
  html_node("[class='spaced stripedRows']")%>%
  html_table()

states <- as.data.frame(states)
states <- states[-(51:67),]

names(states)[names(states) == "US State:"] <- "STATE"
names(states)[names(states) == "Abbreviation:"] <- "STATE_ABBREVIATION"
states %>% slice(1:2)

```
At this point, the two tables were merged by the column "STATE".
```{r}
Income_per_state <- merge(income,states,by="STATE")
slice(Income_per_state, 1:4)
```

```{r include=FALSE}
write.csv(Income_per_state, file="C:/Users/enxhi/Desktop/R_independentstudy/R_project/Data/Income_per_state.csv")

```

To derive the final dataset, this table was merged with the csv dataset provided by the company.
```{r}
names(DF)[names(DF) == "STATE"] <- "STATE_ABBREVIATION"
DF1 <- merge(DF,Income_per_state, by = "STATE_ABBREVIATION")
```
```{r include=FALSE}
write.csv(DF1, file="C:/Users/enxhi/Desktop/R_independentstudy/R_project/Data/Rate_Demo_Income.csv")
```

## Data preparation
Variable churn creation

Because the average income from the table scraped belongs to the year 2015,for this analysis only the observations of 2015 will be considered. 

```{r results="hide"}
DF1$SNAPSHOT_DATE <- as.character(DF1$SNAPSHOT_DATE)
DF1$SNAPSHOT_DATE <- as.Date(DF1$SNAPSHOT_DATE, format = "%m/%d/%Y")
```

```{r results="hide"}
DF2 <-DF1 %>% 
  filter(SNAPSHOT_DATE>'2014-12-31' & SNAPSHOT_DATE<'2016-01-31')

length(unique(DF2$SNAPSHOT_DATE))
unique(DF2$SNAPSHOT_DATE)
```


From the dataset, it can be clearly seen that the variable CVGENDERCODE1, which is showing the gender, has more than two occurrences. Let us make some inspections about it.

```{r results="hide"}
length(unique(DF2$CVGENDERCODE1))
DF2$CVGENDERCODE1 <- as.character(DF2$CVGENDERCODE1)
count(DF2$CVGENDERCODE1=="U")
```

```{r}
DF2$CVGENDERCODE1 <- revalue(DF2$CVGENDERCODE1, c("U"=NA))
count(DF2$CVGENDERCODE1=="M")

```

```{r results="hide"}
DF2$CVGENDERCODE1[is.na(DF2$CVGENDERCODE1)] <- "M"
count(DF2$CVGENDERCODE1=="M")
```

To see how the customer's paying rate has changed a new variable was created as difference between CURR_PAYING_RATE and PRIOR_PAYING_RATE.
```{r include=FALSE}
is.numeric(DF2$CURR_PAYING_RATE)
is.factor(DF2$PRIOR_PAYING_RATE)

DF2$CURR_PAYING_RATE <- as.character(DF2$CURR_PAYING_RATE)
DF2$CURR_PAYING_RATE <- as.numeric(DF2$CURR_PAYING_RATE)
DF2$CURR_PAYING_RATE[is.na(DF2$CURR_PAYING_RATE)]<- 0

DF2$PRIOR_PAYING_RATE <- as.character(DF2$PRIOR_PAYING_RATE)
DF2$PRIOR_PAYING_RATE <- as.numeric(DF2$PRIOR_PAYING_RATE)
DF2$PRIOR_PAYING_RATE[is.na(DF2$PRIOR_PAYING_RATE)]<- 0
```

```{r PAYING_RATE_CHANGE, echo=FALSE}
DF3 <- DF2 %>% mutate(PAYING_RATE_CHANGE= CURR_PAYING_RATE - PRIOR_PAYING_RATE)
```

Given the definition of customer churn as "Customers that stopped using company's product or service during a certain time frame", the variables considered for the variable creation were CURR_QTY (which refers to the current quantity of products purchased by the single customer) and PRIOR_QTY.

```{r}
DF3$CHURN <- if_else(DF3$CURR_QTY >= DF3$PRIOR_QTY,0,1)
```

To make this analysis even more dynamic, the binary variable NEW_CUST was created. 
```{r}
DF3$NEW_CUST <- if_else(DF3$CURR_QTY > 0 & DF3$PRIOR_QTY == 0,1,0)
```

```{r include=FALSE}
write.csv(DF3, file="C:/Users/enxhi/Desktop/R_independentstudy/R_project/Data/Final_Data.csv")
```

##Visualization
Is wrong!!!You group them by snapshotdate but they all appear in the dataset once with only 1 BAN_SEQ.
To see the trend of customer numbers throughout the year, they were grouped by snapshot date.
```{r results="hide"}
detach("package:plyr", unload=TRUE)

DF4 <- DF3 %>% 
  group_by(SNAPSHOT_DATE,BAN_SEQ) %>%
  summarise(CUSTOMERS=n())

```

```{r echo=FALSE}
ggplot(DF4, aes(SNAPSHOT_DATE, CUSTOMERS)) + 
  xlab("Timeline") + ylab("Customers by Month") + geom_line() + theme(axis.text.x=element_text(angle=60, hjust=1))

```

```{r echo=FALSE}
ggplot(DF4, aes(SNAPSHOT_DATE, CUSTOMERS)) + scale_x_date(breaks = DF4$SNAPSHOT_DATE, date_labels = '%m/%d') +  scale_y_continuous(breaks = round(seq(min(DF4$CUSTOMERS), max(DF4$CUSTOMERS), by = 100),1)) +
 xlab("Timeline") + ylab("Customers") + geom_line() + theme(axis.text.x=element_text(angle=60, hjust=1))
```

```{r}
ggplot(data = RCC) + geom_bar(aes(x=n_snapshotdate)) + 
  theme(axis.text.x=element_text(angle=60, hjust=1)) + facet_wrap(~BILL_CODE) 

```

```{r}

```

